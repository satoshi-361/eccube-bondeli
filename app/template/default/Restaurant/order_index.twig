{#
This file is part of EC-CUBE

Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved.

http://www.ec-cube.co.jp/

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
#}
{% extends 'default_frame.twig' %}

{% block stylesheet %}
    <link rel="stylesheet" href="{{ asset('assets/css/tempusdominus-bootstrap-4.min.css', 'admin') }}">
    <style type="text/css">
        .datepicker-days th.dow:first-child,
        .datepicker-days td:first-child {
            color: #f00;
        }

        .datepicker-days th.dow:last-child,
        .datepicker-days td:last-child {
            color: #00f;
        }

        .ec-layoutRole .ec-layoutRole__main {
            margin:187px 0!important;
        }
        table th, table th span {
            font-size: 16px !important;
        }
        table td, table td span {
            font-size: 14px !important;
        }
        body a {
            font-size: 14px;
        }
        .action-edit:hover {
          color: #437ec4 !important;
          font-weight: 600;
        }
    </style>
{% endblock stylesheet %}

{% block javascript %}
    <script>
        $(function() {
            $.when(
                $.getScript("{{ asset('assets/js/vendor/moment.min.js', 'admin') }}"),
                $.getScript("{{ asset('assets/js/vendor/moment-with-locales.min.js', 'admin') }}"),
                $.getScript("{{ asset('assets/js/vendor/tempusdominus-bootstrap-4.min.js', 'admin') }}")
            ).done(function() {
                // datetimepicker で value が消えてしまうので data-value に保持しておく
                $('input.datetimepicker-input').each(function() {
                    $(this).data('value', $(this).val());
                });

                $('input.datetimepicker-input').datetimepicker({
                    locale: '{{ eccube_config.locale }}',
                    format: 'YYYY-MM-DD HH:mm:ss',
                    useCurrent: false,
                    buttons: {
                        showToday: true,
                        showClose: true
                    },
                });

                // datetimepicker で value が消えてしまうので更新
                $('input.datetimepicker-input').each(function() {
                    $(this).val($(this).data('value'));
                });
            });

            toggleBtnBulk('input[id^="check_"]', '.btn-bulk-wrapper');
            $('input[id^="check_"]').on('change', function() {
                $('#toggle_check_all').prop('checked', false);
                toggleBtnBulk('input[id^="check_"]', '.btn-bulk-wrapper');
            });

            // 登録チェックボックス
            $('#toggle_check_all').on('change', function() {
                var checked = $(this).prop('checked');
                if (checked) {
                    $('input[id^="check_"]').prop('checked', true);
                } else {
                    $('input[id^="check_"]').prop('checked', false);
                }
                toggleBtnBulk('input[id^="check_"]', '.btn-bulk-wrapper');
            });

            $('#btn_bulk_delete').on('click', function(event) {
                event.preventDefault();
                $('#form_bulk').attr('action', "{{ url('admin_order_bulk_delete') }}").submit();
                return false;
            });

            // PDF出力(複数)
            $('#bulkExportPdf').on('click', function(event) {
                window.open('', 'newwin', 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=700, height=700');
                $('#form_bulk').attr('action', "{{ url('admin_order_export_pdf') }}");
                $('#form_bulk').attr('target', 'newwin');
                $('#form_bulk').submit();
                return false;
            });

            // PDF出力(単一)
            $('.pdf-print').click(function() {
                window.open(this.href, 'newwin', 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=700, height=700');
                return false;
            });

            // 送り状番号
            var updateTrackingNumber = function(id, url, tracking_number, callback) {
                $.ajax({
                    type: 'PUT',
                    url: url,
                    data: {'tracking_number': tracking_number}
                }).done(function(data, textStatus, jqXHR) {
                    if (data['status'] == 'OK') {
                        $('#tracking_number_' + id).val(data['tracking_number']);
                        if (typeof callback == 'function') {
                            callback();
                        }
                    } else {
                        alert('Update failed.');
                    }
                    return true;
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    var response = JSON.parse(jqXHR.responseText);
                    var messages = '';
                    for (var i = 0; i < response.messages.length; i++) {
                        messages += response.messages[i] + "\n";
                    }
                    alert(messages);
                    return false;
                });
            };

            $('button.update_tracking_number').prop('disabled', true);
            // フォームに変更があったら更新ボタンを有効にする
            $('input.update_tracking_number').on('keyup', function(event) {
                var $tracking_number = $(this);
                var $button = $("button[data-target='#" + $tracking_number.attr('id') + "']");
                $button.prop('disabled', false);
                $button.children('i')
                    .removeClass('text-secondary')
                    .addClass('text-success');
            });
            // enter キーで更新し、次のフォームへフォーカスを移動する
            $('input.update_tracking_number').on('keypress', function(event) {
                var $tracking_number = $(this);
                var $button = $("button[data-target='#" + $tracking_number.attr('id') + "']");

                var code = event.which ? event.which : event.keyCode;

                if (code == 13) { // on press to enter
                    var index = $('input.update_tracking_number').index(this);
                    var callback = function() {
                        $button.prop('disabled', true);
                        $button.children('i')
                            .removeClass('text-success')
                            .addClass('text-secondary');
                        $('input.update_tracking_number:gt(' + index + '):first').focus();
                    };
                    updateTrackingNumber($tracking_number.data('shipping_id'), $tracking_number.data('url'), $tracking_number.val(), callback);
                    event.preventDefault();
                }
            });
            // 更新ボタンの制御
            $('button.update_tracking_number').on('click', function(event) {
                event.preventDefault();
                var $button = $(this);
                var $target = $($(this).data('target'));
                var tracking_number = $target.val();
                var callback = function() {
                    $button.prop('disabled', true);
                    $button.children('i')
                        .removeClass('text-success')
                        .addClass('text-secondary');
                };

        updateTrackingNumber($target.data('shipping_id'), $target.data('url'), tracking_number, callback);
    });

    // 完了ボタン
    $('#bulkChangeComplete').on('click', function() {
        location.href = '{{ url('admin_order', { 'resume': 1 }) }}';
    });

});
</script>

{% endblock javascript %}

{% block main %}
    <!--検索条件設定テーブルここまで-->

    <div class="c-contentsArea__cols">
        <div class="c-contentsArea__primaryCol">
            <div class="c-primaryCol">
                {% if pagination and pagination.totalItemCount %}
                    <form id="form_bulk" method="POST" action="" style="max-width: 1360px; margin: auto; padding: 2rem; box-shadow: 0px 0px 30px 10px #dddddd;">
                        <input type="hidden" name="{{ constant('Eccube\\Common\\Constant::TOKEN_NAME') }}" value="{{ csrf_token(constant('Eccube\\Common\\Constant::TOKEN_NAME')) }}">
                        <div class="row justify-content-between mb-2">
                            <div class="col-7">
                                <div class="row justify-content-between">
                                    <div class="col-auto d-none btn-bulk-wrapper">
                                        <label class="mr-2" data-tooltip="true" data-placement="top" title="{{ 'tooltip.order.bulk_actions'|trans }}">{{ 'admin.common.bulk_actions'|trans }}<i class="fa fa-question-circle fa-lg ml-1"></i></label>
                                        <button id="bulkSendMail" type="button" class="btn btn-ec-regular mr-2" data-type="mail" data-bulk-update="true">
                                            {{ 'admin.order.send_mail'|trans }}
                                        </button>
                                        <button type="button" id="bulkExportPdf" class="btn btn-ec-regular mr-2">{{ 'admin.order.output_delivery_note_short'|trans }}</button>
                                        {# TODO 削除処理は将来バージョンで対応 <button type="button" class="btn btn-ec-delete" data-toggle="modal" data-target="#bulkDeleteModal">{{ 'admin.common.delete'|trans }}</button> #}
                                    </div>
                                </div>
                            </div>
                            <div class="col-5 text-right">
                                <div class="d-inline-block">
                                    <div class="btn-group" role="group">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-ec-regular" data-toggle="dropdown" id="csvDownloadDropDown">
                                                <i class="fa fa-cloud-download mr-1 text-secondary"></i>
                                                <span>{{ 'admin.common.csv_download'|trans }}</span>
                                            </button>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item" href="{{ url('export_order_csv', {id: Restaurant_id}) }}" id="orderCsvDownload">
                                                    {{ 'admin.order.order_csv'|trans }}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card rounded border-0 mb-4 d-block">
                            <div class="card-body p-0">
                                <table class="table table-sm" id="search_result">
                                    <thead>
                                    <tr>
                                        <th class="border-top-0 pt-2 pb-2 text-center pl-3">
                                            <input type="checkbox" id="toggle_check_all" name="filter" value="open">
                                        </th>
                                        <th class="border-top-0 pt-2 pb-2 text-center">{{ 'admin.order.orderer'|trans }}</th>
                                        <th class="border-top-0 pt-2 pb-2 text-center">{{ 'admin.order.order_status'|trans }}</th>
                                        <th class="border-top-0 pt-2 pb-2 text-center">{{ 'admin.order.purchase_price'|trans }}</th>
                                        <th class="border-top-0 pt-2 pb-2 text-center">送料</th>
                                        <th class="border-top-0 pt-2 pb-2 text-center">金額合計</th>
                                        <th class="border-top-0 pt-2 pb-2 text-center">{{ 'admin.order.delivery'|trans }}</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for Order in pagination %}
                                        {% for Shipping in Order.Shippings %}
                                            <tr>
                                                <td class="align-middle text-center pl-3">
                                                    <input type="checkbox" id="check_{{ Shipping.id }}" data-id="{{ Shipping.id }}" name="ids[]" value="{{ Shipping.id }}"
                                                           data-preview-notify-mail-url="{{ url('admin_shipping_preview_notify_mail', { id: Shipping.id}) }}"
                                                           data-notify-mail-url="{{ url('admin_shipping_notify_mail', { id: Shipping.id}) }}"
                                                           data-update-status-url="{{ url('admin_shipping_update_order_status', { id: Shipping.id}) }}"
                                                    />
                                                </td>
                                                <td class="align-middle text-center">
                                                    <a class="action-edit" href="{{ url('order_edit', { id : Restaurant_id, order_no : Order.id }) }}">{{ Order.order_no }}<br>{{ Order.name01 ~ Order.name02 }}<br>{{ Order.order_date|date_min }}</a>
                                                </td>
                                                <td class="align-middle text-center">
                                                    <span class="badge badge-ec-blue" style="background-color: #fff; color: {{ Order.OrderStatusColor }}; border-color: {{ Order.OrderStatusColor }}">{% if Order.OrderStatus == '購入処理中' %}購入エラー{% else %}{{ Order.OrderStatus }}{% endif %}</span>
                                                </td>
                                                <td class="align-middle text-center">
                                                    {{ Order.subtotal|price }}<br>
                                                </td>
                                                <td class="align-middle text-center">
                                                    {{ Order.delivery_fee_total|price }}<br>
                                                </td>
                                                <td class="align-middle text-center">
                                                    {{ Order.payment_total|price }}<br>
                                                </td>
                                                <td class="align-middle text-center">
                                                    {{ Shipping.name01 ~ Shipping.name02 }}<br>
                                                    {{ Shipping.Pref.name }}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% endfor %}
                                    </tbody>
                                </table>
                                <div class="row justify-content-md-center mb-4"></div>
                            </div>
                            <div class="row justify-content-md-center mb-4">
                                {% if pagination.totalItemCount > 0 %}
                                    {% include "pager.twig" with { 'pages' : pagination.paginationData } %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <p style="margin-top: 20px; text-align: center;"><a href="{{ url('restaurant_page', {id: Restaurant_id}) }}" class="btn btn-ec-regular" >戻る</a></p>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
